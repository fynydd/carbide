(function(a,o,g,m){var c=a(o),b=a(g),l="fluidbox",f={immediateOpen:false,loader:false,maxWidth:0,maxHeight:0,resizeThrottle:500,stackIndex:1000,stackIndexDelta:10,viewportFill:0.95,},i={},j=["keyup","keydown","keypress"];var h=0;if(typeof console==="undefined"||console.warn==="undefined"){console={};console.warn=function(){}}if(!a.isFunction(a.throttle)){console.warn("Fluidbox: The jQuery debounce/throttle plugin is not found/loaded. Even though Fluidbox works without it, the window resize event will fire extremely rapidly in browsers, resulting in significant degradation in performance upon viewport resize.")}var n=function(){var q,p=g.createElement("fakeelement");var r={transition:"transitionend",OTransition:"oTransitionEnd",MozTransition:"transitionend",WebkitTransition:"webkitTransitionEnd"};for(q in r){if(p.style[q]!==m){return r[q]}}};var e=n();function k(p,r){this.element=p;var q={};a.each(a(this.element).data(),function(t,w){var s=function(v){return v&&v[0].toLowerCase()+v.slice(1)},u=s(t.replace("fluidbox",""));if(u!==""||u!==null){if(w=="false"){w=false}else{if(w=="true"){w=true}}q[u]=w}});this.settings=a.extend({},f,r,q);this.settings.viewportFill=Math.max(Math.min(parseFloat(this.settings.viewportFill),1),0);if(this.settings.stackIndex<this.settings.stackIndexDelta){settings.stackIndexDelta=settings.stackIndex}this._name=l;this.init()}var d={dom:function(){var p=a("<div />",{"class":"fluidbox__wrap",css:{zIndex:this.settings.stackIndex-this.settings.stackIndexDelta}});a(this.element).addClass("fluidbox--closed").wrapInner(p).find("img").first().css({opacity:1}).addClass("fluidbox__thumb").after('<div class="fluidbox__ghost" />');if(this.settings.loader){var q=a("<div />",{"class":"fluidbox__loader",css:{zIndex:2}});a(this.element).find(".fluidbox__wrap").append(q)}},prepareFb:function(){var q=this,p=a(this.element);p.trigger("thumbloaddone.fluidbox");d.measure.fbElements.call(this);q.bindEvents();p.addClass("fluidbox--ready");q.bindListeners();p.trigger("ready.fluidbox")},measure:{viewport:function(){i.viewport={w:c.width(),h:c.height()}},fbElements:function(){var t=this,p=a(this.element),r=p.find("img").first(),q=p.find(".fluidbox__ghost"),s=p.find(".fluidbox__wrap");t.instanceData.thumb={natW:r[0].naturalWidth,natH:r[0].naturalHeight,w:r.width(),h:r.height()};q.css({width:r.width(),height:r.height(),top:r.offset().top-s.offset().top+parseInt(r.css("borderTopWidth"))+parseInt(r.css("paddingTop")),left:r.offset().left-s.offset().left+parseInt(r.css("borderLeftWidth"))+parseInt(r.css("paddingLeft"))})}},checkURL:function(q){var p=0;if(/[\s+]/g.test(q)){console.warn("Fluidbox: Fluidbox opening is halted because it has detected characters in your URL string that need to be properly encoded/escaped. Whitespace(s) have to be escaped manually. See RFC3986 documentation.");p=1}else{if(/[\"\'\(\)]/g.test(q)){console.warn("Fluidbox: Fluidbox opening will proceed, but it has detected characters in your URL string that need to be properly encoded/escaped. These will be escaped for you. See RFC3986 documentation.");p=0}}return p},formatURL:function(p){return p.replace(/"/g,"%22").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29")}};a.extend(k.prototype,{init:function(){var r=this,p=a(this.element),q=p.find("img").first();d.measure.viewport();if((!r.instanceData||!r.instanceData.initialized)&&(p.is("a")&&p.children().length===1&&(p.children().is("img")||(p.children().is("picture")&&p.find("img").length===1))&&p.css("display")!=="none"&&p.children().css("display")!=="none"&&p.parents().css("display")!=="none")){p.removeClass("fluidbox--destroyed");r.instanceData={};r.instanceData.initialized=true;r.instanceData.originalNode=p.html();h+=1;r.instanceData.id=h;p.addClass("fluidbox__instance-"+h);p.addClass("fluidbox--initialized");d.dom.call(r);p.trigger("init.fluidbox");var s=new Image();if(q.width()>0&&q.height()>0){d.prepareFb.call(r)}else{s.onload=function(){d.prepareFb.call(r)};s.onerror=function(){p.trigger("thumbloadfail.fluidbox")};s.src=q.attr("src")}}},open:function(){var u=this,p=a(this.element),s=p.find("img").first(),q=p.find(".fluidbox__ghost"),t=p.find(".fluidbox__wrap");u.instanceData.state=1;q.off(e);a(".fluidbox--opened").fluidbox("close");var r=a("<div />",{"class":"fluidbox__overlay",css:{zIndex:-1}});t.append(r);p.removeClass("fluidbox--closed").addClass("fluidbox--loading");if(d.checkURL(s.attr("src"))){u.close();return false}q.css({"background-image":"url("+d.formatURL(s.attr("src"))+")",opacity:1});d.measure.fbElements.call(u);var v;if(u.settings.immediateOpen){p.addClass("fluidbox--opened fluidbox--loaded").find(".fluidbox__wrap").css({zIndex:u.settings.stackIndex+u.settings.stackIndexDelta});p.trigger("openstart.fluidbox");u.compute();s.css({opacity:0});a(".fluidbox__overlay").css({opacity:1});q.one(e,function(){p.trigger("openend.fluidbox")});v=new Image();v.onload=function(){p.trigger("imageloaddone.fluidbox");if(u.instanceData.state===1){u.instanceData.thumb.natW=v.naturalWidth;u.instanceData.thumb.natH=v.naturalHeight;p.removeClass("fluidbox--loading");if(d.checkURL(v.src)){u.close({error:true});return false}q.css({"background-image":"url("+d.formatURL(v.src)+")"});u.compute()}};v.onerror=function(){u.close({error:true});p.trigger("imageloadfail.fluidbox");p.trigger("delayedloadfail.fluidbox")};v.src=p.attr("href")}else{v=new Image();v.onload=function(){p.trigger("imageloaddone.fluidbox");p.removeClass("fluidbox--loading").addClass("fluidbox--opened fluidbox--loaded").find(".fluidbox__wrap").css({zIndex:u.settings.stackIndex+u.settings.stackIndexDelta});p.trigger("openstart.fluidbox");if(d.checkURL(v.src)){u.close({error:true});return false}q.css({"background-image":"url("+d.formatURL(v.src)+")"});u.instanceData.thumb.natW=v.naturalWidth;u.instanceData.thumb.natH=v.naturalHeight;u.compute();s.css({opacity:0});a(".fluidbox__overlay").css({opacity:1});q.one(e,function(){p.trigger("openend.fluidbox")})};v.onerror=function(){u.close({error:true});p.trigger("imageloadfail.fluidbox")};v.src=p.attr("href")}},compute:function(){var v=this,p=a(this.element),r=p.find("img").first(),q=p.find(".fluidbox__ghost"),s=p.find(".fluidbox__wrap");var z=v.instanceData.thumb.natW,y=v.instanceData.thumb.natH,C=v.instanceData.thumb.w,w=v.instanceData.thumb.h;var G=z/y,H=i.viewport.w/i.viewport.h;if(v.settings.maxWidth>0){z=v.settings.maxWidth;y=z/G}else{if(v.settings.maxHeight>0){y=v.settings.maxHeight;z=y*G}}var t,u,B,A,x;if(H>G){t=(y<i.viewport.h)?y:i.viewport.h*v.settings.viewportFill;B=t/w;A=z*(w*B/y)/C;x=B}else{u=(z<i.viewport.w)?z:i.viewport.w*v.settings.viewportFill;A=u/C;B=y*(C*A/z)/w;x=A}if(v.settings.maxWidth&&v.settings.maxHeight){console.warn("Fluidbox: Both maxHeight and maxWidth are specified. You can only specify one. If both are specified, only the maxWidth property will be respected. This will not generate any error, but may cause unexpected sizing behavior.")}var E=c.scrollTop()-r.offset().top+0.5*(w*(x-1))+0.5*(c.height()-w*x),D=0.5*(C*(x-1))+0.5*(c.width()-C*x)-r.offset().left,F=parseInt(A*100)/100+","+parseInt(B*100)/100;q.css({transform:"translate("+parseInt(D*100)/100+"px,"+parseInt(E*100)/100+"px) scale("+F+")",top:r.offset().top-s.offset().top,left:r.offset().left-s.offset().left});p.find(".fluidbox__loader").css({transform:"translate("+parseInt(D*100)/100+"px,"+parseInt(E*100)/100+"px) scale("+F+")"});p.trigger("computeend.fluidbox")},recompute:function(){this.compute()},close:function(v){var w=this,p=a(this.element),s=p.find("img").first(),q=p.find(".fluidbox__ghost"),t=p.find(".fluidbox__wrap"),r=p.find(".fluidbox__overlay"),u=a.extend(null,{error:false},v);if(w.instanceData.state===null||typeof w.instanceData.state===typeof m||w.instanceData.state===0){return false}w.instanceData.state=0;p.trigger("closestart.fluidbox");p.removeClass(function(y,x){return(x.match(/(^|\s)fluidbox--(opened|loaded|loading)+/g)||[]).join(" ")}).addClass("fluidbox--closed");q.css({transform:"translate(0,0) scale(1,1)",top:s.offset().top-t.offset().top+parseInt(s.css("borderTopWidth"))+parseInt(s.css("paddingTop")),left:s.offset().left-t.offset().left+parseInt(s.css("borderLeftWidth"))+parseInt(s.css("paddingLeft"))});p.find(".fluidbox__loader").css({transform:"none"});q.one(e,function(){q.css({opacity:0});s.css({opacity:1});r.remove();t.css({zIndex:w.settings.stackIndex-w.settings.stackIndexDelta});p.trigger("closeend.fluidbox")});if(u.error){q.trigger("transitionend")}r.css({opacity:0})},bindEvents:function(){var q=this,p=a(this.element);p.on("click.fluidbox",function(r){r.preventDefault();r.stopPropagation();if(!q.instanceData.state||q.instanceData.state===0){q.open()}else{q.close()}});b.on("keydown",function(r){if(r.keyCode===27){q.close()}})},bindListeners:function(){var q=this,p=a(this.element);var r=function(){d.measure.viewport();d.measure.fbElements.call(q);if(p.hasClass("fluidbox--opened")){q.compute()}};if(a.isFunction(a.throttle)){c.on("resize.fluidbox"+q.instanceData.id,a.throttle(q.settings.resizeThrottle,r))}else{c.on("resize.fluidbox"+q.instanceData.id,r)}p.on("reposition.fluidbox",function(){q.reposition()});p.on("recompute.fluidbox, compute.fluidbox",function(){q.compute()});p.on("destroy.fluidbox",function(){q.destroy()});p.on("close.fluidbox",function(){q.close()})},unbind:function(){a(this.element).off("click.fluidbox reposition.fluidbox recompute.fluidbox compute.fluidbox destroy.fluidbox close.fluidbox");c.off("resize.fluidbox"+this.instanceData.id)},reposition:function(){d.measure.fbElements.call(this)},destroy:function(){var p=this.instanceData.originalNode;this.unbind();a.data(this.element,"plugin_"+l,null);a(this.element).removeClass(function(r,q){return(q.match(/(^|\s)fluidbox[--|__]\S+/g)||[]).join(" ")}).empty().html(p).addClass("fluidbox--destroyed").trigger("destroyed.fluidbox")},getMetadata:function(){return this.instanceData}});a.fn[l]=function(q){var p=arguments;if(q===m||typeof q==="object"){return this.each(function(){if(!a.data(this,"plugin_"+l)){a.data(this,"plugin_"+l,new k(this,q))}})}else{if(typeof q==="string"&&q[0]!=="_"&&q!=="init"){var r;this.each(function(){var s=a.data(this,"plugin_"+l);if(s instanceof k&&typeof s[q]==="function"){r=s[q].apply(s,Array.prototype.slice.call(p,1))}else{console.warn('Fluidbox: The method "'+q+'" used is not defined in Fluidbox. Please make sure you are calling the correct public method.')}});return r!==m?r:this}}return this}})(jQuery,window,document);